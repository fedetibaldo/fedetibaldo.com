---
import { getCollection } from "astro:content";
import { Layout } from "../features/layout";
import type { GetStaticPaths } from "astro";
import { render } from "astro:content";
import { getEntries, type EntryOfType } from "../features/entries";
import Tag from "../ui/Tag.astro";
import { getEntry } from "astro:content";
import { Image } from "astro:assets";

export const getStaticPaths: GetStaticPaths = async () => {
	return (
		await getCollection(
			"entries",
			(entry): entry is EntryOfType<"post"> => entry.data.type == "post",
		)
	).map((post) => ({
		params: { post: post.id },
		props: post,
	}));
};

type Props = EntryOfType<"post">;

const post = Astro.props;

const { Content } = await render(post);

const relatedEntries = await getEntries({
	filter: post.data.related
		? { ids: post.data.related }
		: { tags: [post.data.tag.id, "game"], isOutdated: false },
	limit: 2,
});

const tag = await getEntry(post.data.tag);
---

<Layout
	title={post.data.title}
	description={post.data.description}
	sidebar={{
		type: "suggested",
		entries: relatedEntries,
	}}
>
	<div class="relative" slot="hero">
		{
			post.data.isOutdated && (
				<p class="bg-yellow-950 border-yellow-900 border-x text-yellow-50 text-smallest px-4 lg:px-8 py-4">
					This post is outdated. The author might have changed their mind, the
					content might be too old to be relevant, or both. It's preserved here
					for archival purposes.
				</p>
			)
		}
		<div class="absolute inset-x-0 overflow-hidden -z-10">
			<Image
				class="opacity-40 transform translate-x-1/3 -translate-y-1/2"
				style={{
					"mask-image":
						"radial-gradient(50% 50% at 50% 50%, rgba(0,0,0,1),rgba(0,0,0,0))",
				}}
				src={post.data.cover}
				alt=""
			/>
		</div>
	</div>

	<article>
		<p class="flex items-baseline gap-4 mb-4">
			<Tag color={tag.data.color} label={tag.data.label} />
			<time class="text-ds-body" datetime={post.data.createdAt.toISOString()}>
				{
					post.data.createdAt.toLocaleDateString(undefined, {
						dateStyle: "medium",
					})
				}
			</time>
		</p>
		<h1 class="text-ds-headline-1 text-contrast-high mb-10">
			{post.data.title}
		</h1>
		<div class="prose">
			<Content />
		</div>
	</article>
</Layout>
